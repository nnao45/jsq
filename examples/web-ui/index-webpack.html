<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JSQ Browser - æœ¬ç‰©ã®JSQã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§ï¼</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸš€ JSQ Browser Edition</h1>
      <p class="subtitle">æœ¬ç‰©ã®JSQã‚³ãƒ¼ãƒ‰ãŒãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ä½œï¼</p>
      <div id="init-status" class="init-status">åˆæœŸåŒ–ä¸­...</div>
    </header>

    <div class="main-content">
      <div class="input-section">
        <div class="section-header">
          <h2>å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ (JSON)</h2>
          <button id="load-sample-data" class="btn-secondary">ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€</button>
        </div>
        <textarea id="json-input" placeholder='{"users": [{"name": "Alice", "age": 25}, {"name": "Bob", "age": 30}]}' spellcheck="false">{
  "users": [
    {"name": "Alice", "age": 25, "city": "Tokyo"},
    {"name": "Bob", "age": 30, "city": "Osaka"},
    {"name": "Charlie", "age": 35, "city": "Tokyo"}
  ],
  "products": [
    {"name": "Laptop", "price": 120000, "category": "Electronics"},
    {"name": "Coffee", "price": 500, "category": "Beverage"},
    {"name": "Book", "price": 2000, "category": "Media"}
  ]
}</textarea>
      </div>

      <div class="expression-section">
        <div class="section-header">
          <h2>JSQå¼</h2>
          <div class="example-buttons">
            <button class="example-btn" data-example="$.users.filter(u => u.age > 28)">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ä¾‹</button>
            <button class="example-btn" data-example="$.users.map(u => u.name)">ãƒãƒƒãƒ—ä¾‹</button>
            <button class="example-btn" data-example="$.users | _.groupBy('city')">ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ä¾‹</button>
            <button class="example-btn" data-example="$.products | _.sumBy('price')">é›†è¨ˆä¾‹</button>
            <button class="example-btn" data-example="$.users.name">SmartDollarä¾‹</button>
          </div>
        </div>
        <textarea id="expression-input" placeholder="$.users.filter(u => u.age > 25)" spellcheck="false">$.users.filter(u => u.age > 25)</textarea>
        <button id="evaluate-btn" class="btn-primary" disabled>å®Ÿè¡Œ (Ctrl+Enter)</button>
      </div>

      <div class="output-section">
        <div class="section-header">
          <h2>çµæœ</h2>
          <div class="output-controls">
            <button id="copy-result" class="btn-secondary">çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
            <label class="checkbox-label">
              <input type="checkbox" id="show-transformed" />
              å¤‰æ›å¾Œã®å¼ã‚’è¡¨ç¤º
            </label>
          </div>
        </div>
        <div id="transformed-expression" class="transformed-expression" style="display: none;"></div>
        <pre id="result-output"><code class="language-json"></code></pre>
        <div id="error-output" class="error-message" style="display: none;"></div>
      </div>

      <div class="console-section">
        <div class="section-header">
          <h2>ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›</h2>
          <button id="clear-console" class="btn-secondary">ã‚¯ãƒªã‚¢</button>
        </div>
        <div id="console-output"></div>
      </div>
    </div>

    <footer>
      <div class="info-section">
        <h3>ä½¿ã„æ–¹</h3>
        <ul>
          <li><code>$</code> - å…¥åŠ›ãƒ‡ãƒ¼ã‚¿å…¨ä½“ã«ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆSmartDollarè¨˜æ³•ï¼‰</li>
          <li><code>_</code> - Lodashãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°</li>
          <li><code>console.log()</code> - ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›</li>
          <li><kbd>Ctrl</kbd> + <kbd>Enter</kbd> - å¼ã‚’å®Ÿè¡Œ</li>
          <li>ãƒ‘ã‚¤ãƒ—æ¼”ç®—å­ <code>|</code> ã‚’ã‚µãƒãƒ¼ãƒˆ</li>
        </ul>
      </div>
      
      <div class="info-section">
        <h3>ã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã¤ã„ã¦</h3>
        <ul>
          <li>æœ¬ç‰©ã®JSQã‚³ã‚¢ã‚¨ãƒ³ã‚¸ãƒ³ã‚’ä½¿ç”¨</li>
          <li>QuickJS WASMã«ã‚ˆã‚‹ã‚»ã‚­ãƒ¥ã‚¢ãªå®Ÿè¡Œç’°å¢ƒ</li>
          <li>å¼å¤‰æ›ãƒ»SmartDollarãƒ»Lodashã™ã¹ã¦æœ¬ç‰©</li>
          <li>Node.jsç‰ˆã¨åŒã˜è©•ä¾¡çµæœã‚’æä¾›</li>
        </ul>
      </div>
    </footer>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  
  <!-- JSQãƒãƒ³ãƒ‰ãƒ«ã•ã‚ŒãŸJavaScript -->
  <script>
    // JSQã®åˆæœŸåŒ–ã¨UIåˆ¶å¾¡
    let jsqReady = false;
    
    window.addEventListener('DOMContentLoaded', () => {
      // JSQã®åˆæœŸåŒ–ã‚’å¾…ã¤
      const checkInterval = setInterval(() => {
        if (window.jsq && typeof window.jsq.evaluate === 'function') {
          jsqReady = true;
          clearInterval(checkInterval);
          document.getElementById('init-status').textContent = 'âœ… JSQæº–å‚™å®Œäº†ï¼';
          document.getElementById('init-status').style.color = '#10b981';
          document.getElementById('evaluate-btn').disabled = false;
          setupEventListeners();
        }
      }, 100);
      
      // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†
      setTimeout(() => {
        if (!jsqReady) {
          clearInterval(checkInterval);
          document.getElementById('init-status').textContent = 'âŒ åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ';
          document.getElementById('init-status').style.color = '#ef4444';
        }
      }, 10000);
    });
    
    // è©•ä¾¡é–¢æ•°
    async function evaluate() {
      if (!jsqReady) {
        showError('JSQãŒã¾ã åˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }
      
      const jsonInput = document.getElementById('json-input').value;
      const expression = document.getElementById('expression-input').value;
      const resultOutput = document.getElementById('result-output').querySelector('code');
      const errorOutput = document.getElementById('error-output');
      const transformedDiv = document.getElementById('transformed-expression');
      
      // UIã‚’ãƒªã‚»ãƒƒãƒˆ
      errorOutput.style.display = 'none';
      transformedDiv.textContent = '';
      clearConsole();
      document.getElementById('evaluate-btn').classList.add('loading');
      
      try {
        // JSONãƒ‘ãƒ¼ã‚¹
        let data;
        try {
          data = JSON.parse(jsonInput);
        } catch (e) {
          throw new Error('JSONã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
        }
        
        // å¤‰æ›å¾Œã®å¼ã‚’è¡¨ç¤ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        if (document.getElementById('show-transformed').checked) {
          try {
            const transformed = window.jsq.transform(expression);
            transformedDiv.textContent = 'å¤‰æ›å¾Œ: ' + transformed;
            transformedDiv.style.display = 'block';
          } catch (e) {
            console.error('Transform failed:', e);
          }
        }
        
        // JSQã§è©•ä¾¡
        const result = await window.jsq.evaluate(expression, data, {
          verbose: false,
          sandbox: true
        });
        
        // çµæœã‚’è¡¨ç¤º
        resultOutput.textContent = JSON.stringify(result, null, 2);
        if (window.Prism) {
          Prism.highlightElement(resultOutput);
        }
        
      } catch (error) {
        showError(error.message);
      } finally {
        document.getElementById('evaluate-btn').classList.remove('loading');
      }
    }
    
    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    function showError(message) {
      const errorOutput = document.getElementById('error-output');
      errorOutput.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + message;
      errorOutput.style.display = 'block';
      
      const resultOutput = document.getElementById('result-output').querySelector('code');
      resultOutput.textContent = '';
    }
    
    // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¯ãƒªã‚¢
    function clearConsole() {
      document.getElementById('console-output').innerHTML = '';
    }
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
    function setupEventListeners() {
      // è©•ä¾¡ãƒœã‚¿ãƒ³
      document.getElementById('evaluate-btn').addEventListener('click', evaluate);
      
      // Ctrl+Enterã§å®Ÿè¡Œ
      document.getElementById('expression-input').addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 'Enter' && jsqReady) {
          evaluate();
        }
      });
      
      // å¤‰æ›è¡¨ç¤ºãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
      document.getElementById('show-transformed').addEventListener('change', (e) => {
        const transformedDiv = document.getElementById('transformed-expression');
        if (!e.target.checked) {
          transformedDiv.style.display = 'none';
        }
      });
      
      // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
      document.getElementById('load-sample-data').addEventListener('click', () => {
        const sampleData = {
          users: [
            { id: 1, name: "Alice", age: 25, city: "Tokyo", active: true },
            { id: 2, name: "Bob", age: 30, city: "Osaka", active: false },
            { id: 3, name: "Charlie", age: 35, city: "Tokyo", active: true },
            { id: 4, name: "David", age: 28, city: "Kyoto", active: true }
          ],
          products: [
            { id: 1, name: "Laptop", price: 120000, category: "Electronics", inStock: true },
            { id: 2, name: "Coffee", price: 500, category: "Beverage", inStock: true },
            { id: 3, name: "Book", price: 2000, category: "Media", inStock: false },
            { id: 4, name: "Headphones", price: 15000, category: "Electronics", inStock: true }
          ],
          stats: {
            totalUsers: 4,
            totalProducts: 4,
            metrics: {
              revenue: 137500,
              growth: 15.5
            }
          }
        };
        
        document.getElementById('json-input').value = JSON.stringify(sampleData, null, 2);
      });
      
      // ä¾‹ãƒœã‚¿ãƒ³
      document.querySelectorAll('.example-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.getElementById('expression-input').value = btn.dataset.example;
          if (jsqReady) evaluate();
        });
      });
      
      // çµæœã‚³ãƒ”ãƒ¼
      document.getElementById('copy-result').addEventListener('click', () => {
        const result = document.getElementById('result-output').textContent;
        navigator.clipboard.writeText(result).then(() => {
          const btn = document.getElementById('copy-result');
          const originalText = btn.textContent;
          btn.textContent = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
          setTimeout(() => {
            btn.textContent = originalText;
          }, 2000);
        });
      });
      
      // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¯ãƒªã‚¢
      document.getElementById('clear-console').addEventListener('click', clearConsole);
      
      // åˆæœŸå®Ÿè¡Œ
      if (jsqReady) evaluate();
    }
    
    // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼‰
    const originalConsole = {
      log: console.log,
      error: console.error,
      warn: console.warn
    };
    
    function addConsoleOutput(type, args) {
      const consoleOutput = document.getElementById('console-output');
      const logDiv = document.createElement('div');
      logDiv.className = `console-log console-${type}`;
      
      const text = args.map(arg => {
        if (typeof arg === 'object' && arg !== null) {
          try {
            return JSON.stringify(arg, null, 2);
          } catch {
            return String(arg);
          }
        }
        return String(arg);
      }).join(' ');
      
      logDiv.textContent = text;
      consoleOutput.appendChild(logDiv);
      consoleOutput.scrollTop = consoleOutput.scrollHeight;
    }
    
    // console.logã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
    console.log = function(...args) {
      originalConsole.log.apply(console, args);
      if (document.getElementById('console-output')) {
        addConsoleOutput('log', args);
      }
    };
  </script>
</body>
</html>