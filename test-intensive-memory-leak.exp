#!/usr/bin/expect -f

set timeout 60
log_user 1

# JSONデータを用意
spawn sh -c {echo '{"a": 1, "b": 2, "c": {"d": 3}}' | node dist/index.js --verbose 2>&1}

# REPLプロンプトを待つ
expect ">"

# より多くの繰り返しでリアルタイム評価を実行
for {set i 0} {$i < 50} {incr i} {
    # 様々な入力パターン
    send "$.a"
    sleep 0.05
    send " + $.b"
    sleep 0.05
    
    # 複数回バックスペース
    for {set j 0} {$j < 8} {incr j} {
        send "\x08"
        sleep 0.02
    }
    
    # 別の式を入力
    send "$.c.d"
    sleep 0.05
    
    # 全削除
    send "\x15"  ;# Ctrl+U (delete to start)
    sleep 0.05
}

# 長い式を入力してから削除
send "Object.keys($).map(k => $[k]).reduce((a,b) => a+b)"
sleep 0.1

# 一文字ずつ削除
for {set i 0} {$i < 45} {incr i} {
    send "\x08"
    sleep 0.01
}

# 終了
send "\x03"
expect eof