"use strict";(this.webpackChunkJSQ=this.webpackChunkJSQ||[]).push([[992],{992:(e,t,o)=>{o.r(t),o.d(t,{VMSandboxSimple:()=>n});var i=o(397);class n{config;appContext;constructor(e,t={}){this.appContext=e,this.config={memoryLimit:this.validatePositiveNumber(t.memoryLimit,128),timeout:this.validatePositiveNumber(t.timeout,3e4),enableAsync:t.enableAsync??!0,enableGenerators:t.enableGenerators??!1,enableProxies:t.enableProxies??!1,enableSymbols:t.enableSymbols??!0,maxContextSize:this.validatePositiveNumber(t.maxContextSize,10485760),recycleIsolates:t.recycleIsolates??!1,isolatePoolSize:this.validatePositiveNumber(t.isolatePoolSize,1)}}async execute(e,t={},o={}){const n=Date.now();let s=null,a=null;try{a=new i.VMEngineFactory(this.appContext).create("quickjs"),await a.initialize(this.config),s=await a.createContext();try{await s.eval("\n          globalThis.__consoleCalls = [];\n          globalThis.console = {\n            log: function(...args) {\n              globalThis.__consoleCalls.push({ method: 'log', args: args });\n            },\n            error: function(...args) {\n              globalThis.__consoleCalls.push({ method: 'error', args: args });\n            },\n            warn: function(...args) {\n              globalThis.__consoleCalls.push({ method: 'warn', args: args });\n            },\n            info: function(...args) {\n              globalThis.__consoleCalls.push({ method: 'info', args: args });\n            },\n            debug: function(...args) {\n              globalThis.__consoleCalls.push({ method: 'debug', args: args });\n            }\n          };\n        ")}catch(e){}for(const[e,o]of Object.entries(t))["console","JSON","Math","Date","Array","Object","String","Number","Boolean"].includes(e)||await s.setGlobal(e,o);const r={log:(...e)=>console.log(...e),error:(...e)=>console.error(...e),warn:(...e)=>console.warn(...e),info:(...e)=>console.info(...e),debug:(...e)=>console.debug(...e)},l=await a.execute(s,e,{},{...o,timeout:o.timeout??this.config.timeout});try{const e=await s.eval("globalThis.__consoleCalls");if(Array.isArray(e))for(const t of e)if(t&&"object"==typeof t&&"method"in t&&"args"in t){const e=t.method;e in r&&Array.isArray(t.args)&&r[e](...t.args)}}catch(e){}const c=Math.max(1,Date.now()-n);return{value:l.value,executionTime:c,memoryUsed:0}}catch(e){const t=Math.max(1,Date.now()-n);throw this.createSandboxError(e,t)}finally{if(s)try{s.release()}catch(e){}if(a)try{await a.dispose()}catch(e){}}}createSandboxError(e,t){let o="EXECUTION_ERROR",i="Unknown error";e instanceof Error?(i=e.message,"TimeoutError"!==e.name&&"TimeoutError"!==e.constructor.name||(o="TIMEOUT")):"string"==typeof e?i=e:e&&"object"==typeof e&&"message"in e&&(i=String(e.message));const n=i.toLowerCase();n.includes("timeout")||n.includes("timed out")||n.includes("execution timed out")||n.includes("script execution timed out")||n.includes("timeout exceeded")||n.includes("execution timeout")||n.includes("script timed out")||n.includes("script execution cancelled")||n.includes("execution was cancelled")||n.includes("cancelled")||i.includes("Script execution timed out")?o="TIMEOUT":n.includes("memory")||n.includes("isolate was disposed")||n.includes("isolate is already disposed")?o="MEMORY_LIMIT":n.includes("syntax")||n.includes("syntaxerror")?o="SYNTAX_ERROR":n.includes("reference")||n.includes("referenceerror")||n.includes("is not defined")?o="REFERENCE_ERROR":n.includes("type")||n.includes("typeerror")?o="TYPE_ERROR":t>=45&&(o="TIMEOUT");const s=new Error(i);return s.code=o,s.details={executionTime:t},s.name="SandboxError",s}async dispose(){}getConfig(){return{memoryLimit:this.config.memoryLimit,timeout:this.config.timeout,enableAsync:this.config.enableAsync,enableGenerators:this.config.enableGenerators,enableProxies:this.config.enableProxies,enableSymbols:this.config.enableSymbols,maxContextSize:this.config.maxContextSize,recycleIsolates:this.config.recycleIsolates,isolatePoolSize:this.config.isolatePoolSize}}getCapabilities(){const e=this.config.memoryLimit<64;return{console:!0,json:!0,math:!0,array:!0,object:!0,promises:this.config.enableAsync,generators:this.config.enableGenerators,proxies:this.config.enableProxies,symbols:this.config.enableSymbols,buffer:!1,crypto:!1,timers:!e,weakmap:!e,intl:!e,number:!0}}getPoolStatus(){return{size:0,maxSize:this.config.isolatePoolSize,available:0,busy:0}}validateContextValue(e){try{const t=this.estimateValueSize(e);return t>this.config.maxContextSize?{valid:!1,error:`Context value too large: ${t} bytes > ${this.config.maxContextSize} bytes`}:{valid:!0}}catch(e){return{valid:!1,error:`Validation error: ${e instanceof Error?e.message:"Unknown error"}`}}}estimateValueSize(e,t=new Set){if(null==e)return 8;if("object"==typeof e&&null!==e&&t.has(e))return 8;switch(typeof e){case"boolean":return 4;case"number":default:return 8;case"string":return 2*e.length;case"bigint":case"function":return 2*e.toString().length;case"object":{if(t.has(e))return 8;t.add(e);let o=16;if(Array.isArray(e))for(const i of e)o+=this.estimateValueSize(i,t);else if(e instanceof Date)o+=8;else if(e instanceof RegExp)o+=2*e.toString().length;else if(e instanceof Map)for(const[i,n]of e)o+=this.estimateValueSize(i,t),o+=this.estimateValueSize(n,t);else if(e instanceof Set)for(const i of e)o+=this.estimateValueSize(i,t);else for(const[i,n]of Object.entries(e))o+=2*i.length,o+=this.estimateValueSize(n,t);return t.delete(e),o}}}validatePositiveNumber(e,t){return"number"==typeof e&&e>0&&!Number.isNaN(e)?e:t}}}}]);