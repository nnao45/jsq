#\!/usr/bin/expect -f

set timeout 5

# Create test data
exec echo {{"autoUpdates": true, "bypassPermissionsModeAccepted": false, "cachedChangelog": null}} > /tmp/test.json

# Start jsq in prompts mode
spawn node dist/index.js --file /tmp/test.json --prompts

expect "Welcome to jsq REPL"
expect -re {\?.*>}

# Type $. and press tab
send "$.\t"
sleep 0.5

# Should show completions
expect "Available completions:"
expect "(Press Tab again to cycle through completions)"

# Press tab again to select first completion
send "\t"
sleep 0.5

expect {
    "autoUpdates" {
        puts "✓ First completion selected: autoUpdates"
    }
    timeout {
        puts "✗ First completion not selected"
    }
}

# Press tab again to cycle to next
send "\t"
sleep 0.5

expect {
    "bypassPermissionsModeAccepted" {
        puts "✓ Cycled to second completion: bypassPermissionsModeAccepted"
    }
    timeout {
        puts "✗ Second completion not selected"
    }
}

# Press tab again to cycle to third
send "\t"
sleep 0.5

expect {
    "cachedChangelog" {
        puts "✓ Cycled to third completion: cachedChangelog"
    }
    timeout {
        puts "✗ Third completion not selected"
    }
}

# Exit
send "\x03\x03"
expect eof

exec rm -f /tmp/test.json
