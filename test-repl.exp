#!/usr/bin/expect -f

# REPLã®ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# manual-test.mdã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ãƒã‚°ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹

set timeout 5
log_user 1

# npm run buildã‚’å®Ÿè¡Œ
spawn npm run build
expect {
    "built successfully" { puts "\nBuild successful!" }
    eof { puts "\nBuild completed!" }
}

# ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’jsqã«æ¸¡ã—ã¦REPLã‚’èµ·å‹•
spawn sh -c {echo '{"test": "data"}' | npx jsq}

# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å¾…ã¤
expect {
    "> " { puts "\nREPL started successfully" }
    timeout { 
        puts "\nError: REPL prompt not found"
        exit 1
    }
}

# å­˜åœ¨ã—ãªã„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã‚¢ã‚¯ã‚»ã‚¹
puts "\nSending: $.aaaaaaaaaaa"
send "$.aaaaaaaaaaa\r"

# çµæœã‚’ç¢ºèª
expect {
    "undefined" { 
        puts "\nâœ… Test PASSED: Non-existent property returns undefined"
    }
    -re "\\{.*\"test\".*:.*\"data\".*\\}" {
        puts "\nâŒ Test FAILED: Non-existent property returned entire object!"
        exit 1
    }
    timeout { 
        puts "\nâŒ Test FAILED: Timeout waiting for response"
        exit 1
    }
}

# æ­£å¸¸ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚¢ã‚¯ã‚»ã‚¹ã‚‚ãƒ†ã‚¹ãƒˆ
send "$.test\r"

expect {
    "data" {
        puts "\nâœ… Test PASSED: Existing property returns correct value"
    }
    timeout {
        puts "\nâŒ Test FAILED: Timeout waiting for $.test response"
        exit 1
    }
}

# REPLã‚’çµ‚äº†
send "\x04"  ;# Ctrl+D

expect eof

puts "\nğŸ‰ All tests passed!"
exit 0