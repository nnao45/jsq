#!/usr/bin/expect -f

set timeout 10

# Start jsq REPL with test data via direct node command
spawn sh -c {echo '{"test": "data"}' | node dist/index.js}

# Wait for prompt
expect {
    "> " { 
        puts "REPL started"
    }
    timeout { 
        puts "Timeout waiting for prompt"
        exit 1
    }
}

# Send the command
sleep 1
send "\$"
sleep 0.1
send "."
sleep 0.1
send "a"
sleep 0.1
send "a"
sleep 0.1
send "a"
sleep 0.1
send "a"
sleep 0.1
send "a"
sleep 0.1
send "a"
sleep 0.1
send "a"
sleep 0.1
send "a"
sleep 0.1
send "a"
sleep 0.1
send "a"
sleep 0.1
send "a"
sleep 0.1
send "a"
sleep 0.1
send "\r"

# Wait a bit for the final result
sleep 1

# Wait for response
expect {
    "undefined" { 
        puts "\n✓ Test PASSED"
        exit 0
    }
    -re "\\{.*test.*:.*data.*\\}" {
        puts "\n✗ Test FAILED: Got entire object"
        exit 1
    }
    timeout {
        puts "\n✗ Test FAILED: Timeout"
        puts "\nBuffer content:"
        expect *
        puts $expect_out(buffer)
        exit 1
    }
}

expect eof