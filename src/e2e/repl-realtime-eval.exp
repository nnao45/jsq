#!/usr/bin/expect -f

set timeout 30
log_user 0

puts "Starting JSQ REPL Real-time Evaluation E2E Tests..."
puts "=================================================="

# Create a temporary file with test data
set tmpfile [exec mktemp]
exec echo {{"test": "data", "value": 42}} > $tmpfile

# Note: This test specifically tests real-time evaluation, so we keep it enabled
spawn node dist/index.js --file $tmpfile

expect "jsq REPL - Interactive JSON Query Tool"
expect "> "

# Test 1: Basic real-time evaluation
puts "\n=== Test 1: Basic real-time evaluation ==="
send "$"
sleep 0.5
send "."
sleep 0.5
send "t"
sleep 0.5
send "e"
sleep 0.5
send "s"
sleep 0.5
send "t"
sleep 1

# Check if we eventually see the result
expect {
    "data" {
        puts "✓ Real-time evaluation showed correct value"
    }
    timeout {
        puts "✗ Failed to show correct value"
        exit 1
    }
}

# Clear line
send "\x03"
sleep 0.5

# Test 2: Test with numbers
puts "\n=== Test 2: Real-time evaluation with numbers ==="
send "$.value\r"
sleep 1

expect {
    "42" {
        puts "✓ Number evaluation showed correct value"
    }
    timeout {
        puts "✗ Failed to show number value"
        exit 1
    }
}

# Exit
send "\x03"
expect {
    timeout { }
    eof { }
}

# Clean up
catch { exec rm $tmpfile }

puts "\n=================================================="
puts "Real-time evaluation E2E tests completed!"

exit 0