#!/usr/bin/expect -f

set timeout 10

# JSONãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™
set tmpfile [exec mktemp /tmp/jsq-test-XXXXXX.json]
exec echo {{"name": "Alice", "age": 25, "skills": ["JavaScript", "TypeScript"], "nested": {"city": "Tokyo"}}} > $tmpfile

puts "=== jsq Prompts REPL E2E Test ==="

# 1. åŸºæœ¬çš„ãªèµ·å‹•ãƒ†ã‚¹ãƒˆ
puts "\n\[1\] Basic startup test"
spawn node dist/index.js --prompts --file $tmpfile
expect "Welcome to jsq REPL (Prompts Edition) ðŸš€"
expect "Type .help for commands, .exit to quit"
expect -re {\?.*>.*â€º}
send ".exit\r"
expect "Bye! ðŸ‘‹"
wait

# 2. åŸºæœ¬çš„ãªã‚¯ã‚¨ãƒªãƒ†ã‚¹ãƒˆ
puts "\n\[2\] Basic query test"
spawn node dist/index.js --prompts --file $tmpfile
expect -re {\?.*>.*â€º}
send "$.name\r"
expect "â†’"
expect "Alice"
expect -re {\?.*>.*â€º}
send "$.age\r"
expect "â†’"
expect "25"
expect -re {\?.*>.*â€º}
send ".exit\r"
expect eof
wait

# 3. ãƒã‚¹ãƒˆã—ãŸãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚¢ã‚¯ã‚»ã‚¹
puts "\n\[3\] Nested property access"
spawn node dist/index.js --prompts --file $tmpfile
expect -re {\?.*>.*â€º}
send "$.nested.city\r"
expect "â†’"
expect "Tokyo"
expect -re {\?.*>.*â€º}
send ".exit\r"
expect eof
wait

# 4. é…åˆ—ã‚¢ã‚¯ã‚»ã‚¹
puts "\n\[4\] Array access"
spawn node dist/index.js --prompts --file $tmpfile
expect -re {\?.*>.*â€º}
send "$.skills[0]\r"
expect "â†’"
expect "JavaScript"
expect -re {\?.*>.*â€º}
send "$.skills\r"
expect "â†’"
expect {JavaScript}
expect {TypeScript}
expect -re {\?.*>.*â€º}
send ".exit\r"
expect eof
wait

# 5. ãƒ˜ãƒ«ãƒ—ã‚³ãƒžãƒ³ãƒ‰
puts "\n\[5\] Help command"
spawn node dist/index.js --prompts --file $tmpfile
expect -re {\?.*>.*â€º}
send ".help\r"
expect "Available commands:"
expect ".exit"
expect ".help"
expect ".clear"
expect ".history"
expect ".save"
expect ".load"
expect ".config"
expect -re {\?.*>.*â€º}
send ".exit\r"
expect eof
wait

# 6. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
puts "\n\[6\] Error handling"
spawn node dist/index.js --prompts --file $tmpfile
expect -re {\?.*>.*â€º}
send "$.nonexistent\r"
expect "â†’"
expect "undefined"
expect -re {\?.*>.*â€º}

# ç„¡åŠ¹ãªå¼ã®ãƒ†ã‚¹ãƒˆ
send "$.\r"
expect "âŒ Syntax Error:"
expect -re {\?.*>.*â€º}

# å­˜åœ¨ã—ãªã„ã‚³ãƒžãƒ³ãƒ‰
send ".unknown\r"
expect "Unknown command:"
expect -re {\?.*>.*â€º}
send ".exit\r"
expect eof
wait

# 7. å±¥æ­´æ©Ÿèƒ½
puts "\n\[7\] History test"
spawn node dist/index.js --prompts --file $tmpfile
expect -re {\?.*>.*â€º}
send "$.name\r"
expect "Alice"
expect -re {\?.*>.*â€º}
send "$.age\r"
expect "25"
expect -re {\?.*>.*â€º}
send ".history\r"
expect "Command history:"
expect "$.name"
expect "$.age"
expect -re {\?.*>.*â€º}
send ".exit\r"
expect eof
wait

# 8. Ctrl+C ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
puts "\n\[8\] Ctrl+C handling"
spawn node dist/index.js --prompts --file $tmpfile
expect -re {\?.*>.*â€º}
send "\x03"
expect "Use .exit to quit"
expect -re {\?.*>.*â€º}
send ".exit\r"
expect eof
wait

# 9. ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜/èª­ã¿è¾¼ã¿
puts "\n\[9\] Save and load session"
set session_file "/tmp/jsq-test-session.json"
exec rm -f $session_file

spawn node dist/index.js --prompts --file $tmpfile
expect -re {\?.*>.*â€º}
send ".save $session_file\r"
expect "Session saved to:"
expect -re {\?.*>.*â€º}
send ".exit\r"
expect eof
wait

# ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®èª­ã¿è¾¼ã¿
spawn node dist/index.js --prompts
expect -re {\?.*>.*â€º}
send ".load $session_file\r"
expect "Session loaded from:"
expect -re {\?.*>.*â€º}
send "$.name\r"
expect "Alice"
expect -re {\?.*>.*â€º}
send ".exit\r"
expect eof
wait

# 10. è¨­å®šè¡¨ç¤º
puts "\n\[10\] Config display"
spawn node dist/index.js --prompts --file $tmpfile
expect -re {\?.*>.*â€º}
send ".config\r"
expect "Current configuration:"
expect "REPL Mode:"
expect "Prompts Edition"
expect -re {\?.*>.*â€º}
send ".exit\r"
expect eof
wait

# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
exec rm -f $tmpfile $session_file

puts "\nâœ“ All Prompts REPL tests passed!"