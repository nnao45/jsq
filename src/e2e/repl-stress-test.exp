#!/usr/bin/expect -f

set timeout 60
log_user 0

# Create a temporary file with test data
set tmpfile [exec mktemp]
exec echo {{"test": "data"}} > $tmpfile

# Start jsq with REPL mode
spawn node dist/index.js --file $tmpfile

expect {
    timeout { exit 1 }
    "jsq REPL"
}

expect {
    timeout { exit 1 }
    "> "
}

# 簡単なストレステスト - 連続入力
foreach num {1 2 3 4 5 6 7 8 9 0} {
    send "$num$num$num$num$num$num$num\r"
    expect {
        timeout { continue }
        -re ".*" { }
    }
}

# .testを実行してJSONを確認
send ".test\r"
expect {
    timeout { exit 1 }
    "\"data\""
}

# Ctrl+Cで終了
send "\x03"
expect {
    timeout { }
    eof { }
}

# Clean up
catch { exec rm $tmpfile }

exit 0